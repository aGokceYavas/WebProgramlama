@model GymManagementApp.Models.RandevuAlViewModel

@{
    ViewData["Title"] = "Randevu Al";
    var gunler = new[] { "Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi", "Pazar" };
}

<div class="container py-5">

    <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-5">
        <div class="card-header text-white p-4" style="background: linear-gradient(135deg, #2c3e50, #4ca1af);">
            <h4 class="fw-bold mb-0"><i class="fa-solid fa-calendar-plus me-2"></i>Yeni Randevu</h4>
            <small class="opacity-75">Lütfen önce almak istediğiniz hizmet paketini seçiniz.</small>
        </div>
        <div class="card-body p-4 bg-light">
            <form method="get" action="Create" class="row align-items-end">
                <div class="col-md-10">
                    <label class="fw-bold text-muted mb-2 small text-uppercase">Hizmet Paketi</label>
                    <select name="paketId" class="form-select form-select-lg rounded-3 shadow-sm border-0" onchange="this.form.submit()">
                        <option value="">-- Paket Seçiniz --</option>
                        @foreach (var p in Model.Paketler)
                        {
                            if (Model.SeciliPaketId == p.Id)
                            {
                                <option value="@p.Id" selected>@p.Ad - @p.Egitmen?.AdSoyad (@p.Sure dk - @p.Ucret ₺)</option>
                            }
                            else
                            {
                                <option value="@p.Id">@p.Ad - @p.Egitmen?.AdSoyad (@p.Sure dk - @p.Ucret ₺)</option>
                            }
                        }
                    </select>
                </div>
            </form>

            @if (User.IsInRole("Admin") && Model.SeciliPaket != null)
            {
                <div class="alert alert-warning mt-4 rounded-3 border-0 shadow-sm d-flex align-items-center">
                    <i class="fa-solid fa-user-gear fa-2x me-3 text-warning"></i>
                    <div class="w-100">
                        <label class="fw-bold text-dark">Admin İşlemi: Randevu Sahibi</label>
                        <select id="adminUyeSecimi" class="form-select mt-1 border-warning">
                            <option value="">-- Kendim İçin Alıyorum --</option>
                            @foreach (var u in Model.Uyeler)
                            {
                                <option value="@u.Id">@u.Email</option>
                            }
                        </select>
                    </div>
                </div>
            }
        </div>
    </div>

    @if (Model.SeciliPaket != null)
    {
        <div class="d-flex align-items-center mb-4 p-3 bg-white rounded-4 shadow-sm border-start border-5 border-success">
            <div class="me-3">
                <i class="fa-solid fa-circle-info fa-2x text-success"></i>
            </div>
            <div>
                <h5 class="fw-bold text-dark mb-0">Müsaitlik Tablosu</h5>
                <span class="text-muted">
                    <strong class="text-success">@Model.Egitmen?.AdSoyad</strong> için
                    <strong>@Model.SeciliPaket.Ad</strong> (@Model.SeciliPaket.Sure dk) saatlerini görüntülüyorsunuz.
                </span>
            </div>
        </div>

        <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle mb-0">
                    <thead>
                        <tr style="background: #2c3e50; color: white;">
                            <th class="py-3" style="width: 80px; background: #243342;"><i class="fa-regular fa-clock"></i></th>
                            @for (int i = 0; i < 7; i++)
                            {
                                var tarih = Model.BaslangicTarihi.AddDays(i);
                                <th class="py-3 @(tarih.Date == DateTime.Today ? "bg-primary bg-opacity-50" : "")">
                                    <div class="fw-bold">@gunler[i]</div>
                                    <small class="opacity-75">@tarih.ToString("dd.MM")</small>
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int gerekliSlot = Model.SeciliPaket.Sure / 30;
                        }

                        @foreach (var saat in Model.SaatDilimleri)
                        {
                            <tr>
                                <td class="fw-bold bg-light text-muted">@saat.ToString(@"hh\:mm")</td>

                                @for (int i = 0; i < 7; i++)
                                {
                                    var hucreTarihi = Model.BaslangicTarihi.AddDays(i);
                                    bool musait = true;
                                    TimeSpan kontrolSaati = saat;

                                    for (int k = 0; k < gerekliSlot; k++)
                                    {
                                        string key = $"{hucreTarihi:yyyy-MM-dd}_{kontrolSaati:hh\\:mm}";
                                        if (Model.DoluSlotlar.Contains(key)) { musait = false; break; }
                                        if (!Model.SaatDilimleri.Contains(kontrolSaati)) { musait = false; break; }
                                        kontrolSaati = kontrolSaati.Add(TimeSpan.FromMinutes(30));
                                    }

                                    bool gecmis = hucreTarihi < DateTime.Today || (hucreTarihi == DateTime.Today && saat < DateTime.Now.TimeOfDay);

                                    <td class="p-1">
                                        @if (gecmis)
                                        {
                                            <span class="text-black-50 small"><i class="fa-solid fa-ban"></i></span>
                                        }
                                        else if (!musait)
                                        {
                                            <button class="btn btn-secondary btn-sm w-100 disabled border-0" style="opacity: 0.3;">
                                                <i class="fa-solid fa-lock"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <button onclick="randevuAl('@hucreTarihi.ToString("yyyy-MM-dd")', '@saat')"
                                                    class="btn btn-outline-success btn-sm w-100 fw-bold border-0 hover-scale">
                                                <i class="fa-solid fa-plus"></i> SEÇ
                                            </button>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

<form id="randevuForm" asp-action="Create" method="post">
    <input type="hidden" name="HizmetPaketiId" value="@Model.SeciliPaketId" />
    <input type="hidden" id="inputTarih" name="Tarih" />
    <input type="hidden" id="inputSaat" name="Saat" />
    <input type="hidden" id="inputUyeId" name="UyeId" />
</form>

<script>
    function randevuAl(tarih, saat) {
        if(confirm(tarih + " " + saat + " için randevuyu onaylıyor musunuz?")) {
            document.getElementById("inputTarih").value = tarih;
            document.getElementById("inputSaat").value = saat;
            var adminSelect = document.getElementById("adminUyeSecimi");
            if (adminSelect && adminSelect.value !== "") {
                document.getElementById("inputUyeId").value = adminSelect.value;
            }
            document.getElementById("randevuForm").submit();
        }
    }
</script>

<style>
    .hover-scale:hover {
        transform: scale(1.1);
        background-color: #28a745;
        color: white;
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }
</style>